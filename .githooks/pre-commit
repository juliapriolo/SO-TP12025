#!/usr/bin/env bash
set -euo pipefail

# Verifica que exista clang-format
if ! command -v clang-format >/dev/null 2>&1; then
  echo "[pre-commit] ERROR: no se encontró 'clang-format' en el PATH." >&2
  echo "Instalalo o corré el commit dentro de la imagen de la cátedra." >&2
  exit 1
fi

# Toma solo archivos staged agregados/cambiados que sean C/C++
# (ajustá extensiones si usás otras)
files="$(
  git diff --cached --name-only --diff-filter=ACM |
    grep -E '\.(c|h|cc|cpp|hpp)$' || true
)"

# Nada para formatear
[ -z "$files" ] && exit 0

echo "[pre-commit] Aplicando clang-format a archivos staged…"

# Formatea y re-agrega al índice
while IFS= read -r f; do
  # Si el archivo sigue existiendo en el árbol de trabajo
  [ -f "$f" ] || continue
  clang-format -style=file --sort-includes -i "$f"
  git add "$f"
done <<< "$files"

# Si el hook hizo cambios, el commit continúa incluyendo el formato aplicado
echo "[pre-commit] Listo."
